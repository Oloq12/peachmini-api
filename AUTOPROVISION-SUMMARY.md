# ‚úÖ Auto-Provision API - –ö—Ä–∞—Ç–∫–∞—è —Å–≤–æ–¥–∫–∞

## –ß—Ç–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

### 1. **Auto-Provision –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π** ‚úÖ
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ `tgId` –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—Ä–æ—Å–µ
- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–≥–æ –∫–æ–¥–∞ (—Ñ–æ—Ä–º–∞—Ç: `REF{tgId-last6}{random3}`)
- –ù–∞—á–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å: 1000 PP

### 2. **–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞** ‚úÖ
- `GET /api/ref/status?tgId=...` - –ø–æ–ª—É—á–∏—Ç—å –∫–æ–¥, —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
- `POST /api/ref/apply` - –ø—Ä–∏–º–µ–Ω–∏—Ç—å –∫–æ–¥, +100 PP –∞–≤—Ç–æ—Ä—É
- –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å - –∫–æ–¥ –º–æ–∂–Ω–æ –ø—Ä–∏–º–µ–Ω–∏—Ç—å —Ç–æ–ª—å–∫–æ 1 —Ä–∞–∑
- –ó–∞—â–∏—Ç–∞ –æ—Ç self-referral

### 3. **–°–∏—Å—Ç–µ–º–∞ –∫–≤–µ—Å—Ç–æ–≤** ‚úÖ
- `GET /api/quests/status?tgId=...` - —Å–ø–∏—Å–æ–∫ –∏–∑ 3 –±–∞–∑–æ–≤—ã—Ö –∫–≤–µ—Å—Ç–æ–≤
- `POST /api/quests/complete` - –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∫–≤–µ—Å—Ç, –ø–æ–ª—É—á–∏—Ç—å –Ω–∞–≥—Ä–∞–¥—É
- –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å - –Ω–∞–≥—Ä–∞–¥–∞ –Ω–∞—á–∏—Å–ª—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ 1 —Ä–∞–∑

### 4. **–ë–∞–∑–æ–≤—ã–µ –∫–≤–µ—Å—Ç—ã**
| –ö–≤–µ—Å—Ç | –ù–∞–≥—Ä–∞–¥–∞ | –û–ø–∏—Å–∞–Ω–∏–µ |
|-------|---------|----------|
| `first_chat` | 50 PP | üí¨ –ü–µ—Ä–≤—ã–π –¥–∏–∞–ª–æ–≥ |
| `create_character` | 100 PP | ‚ú® –°–æ–∑–¥–∞—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ |
| `invite_friend` | 150 PP | üë• –ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –¥—Ä—É–≥–∞ |

---

## üì° API Endpoints

### GET `/api/ref/status?tgId=...`
```bash
curl "http://localhost:8787/api/ref/status?tgId=123456789"

# Response:
{
  "ok": true,
  "data": {
    "referralCode": "REF456789XYZ",
    "refCount": 0,
    "earned": 0,
    "balance": 1000
  }
}
```

### POST `/api/ref/apply`
```bash
curl -X POST http://localhost:8787/api/ref/apply \
  -H "Content-Type: application/json" \
  -d '{"tgId": "987654321", "code": "REF456789XYZ"}'

# Response:
{
  "ok": true,
  "data": {
    "credited": true,
    "amount": 100
  }
}
```

### GET `/api/quests/status?tgId=...`
```bash
curl "http://localhost:8787/api/quests/status?tgId=123456789"

# Response:
{
  "ok": true,
  "data": {
    "quests": [
      {
        "key": "first_chat",
        "title": "–ü–µ—Ä–≤—ã–π –¥–∏–∞–ª–æ–≥",
        "reward": 50,
        "icon": "üí¨",
        "done": false
      },
      ...
    ],
    "totals": {
      "completed": 0,
      "total": 3,
      "earned": 0
    }
  }
}
```

### POST `/api/quests/complete`
```bash
curl -X POST http://localhost:8787/api/quests/complete \
  -H "Content-Type: application/json" \
  -d '{"tgId": "123456789", "key": "first_chat"}'

# Response:
{
  "ok": true,
  "data": {
    "done": true,
    "reward": 50,
    "newBalance": 1050
  }
}
```

---

## üîê –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

### –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å

**–†–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –∫–æ–¥:**
- ‚úÖ –ü–µ—Ä–≤–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ ‚Üí +100 PP –∞–≤—Ç–æ—Ä—É –∫–æ–¥–∞
- ‚úÖ –ü–æ–≤—Ç–æ—Ä–Ω–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ ‚Üí `{ alreadyApplied: true, credited: false }`

**–ö–≤–µ—Å—Ç:**
- ‚úÖ –ü–µ—Ä–≤–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ ‚Üí –Ω–∞–≥—Ä–∞–¥–∞ –Ω–∞—á–∏—Å–ª—è–µ—Ç—Å—è
- ‚úÖ –ü–æ–≤—Ç–æ—Ä–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ ‚Üí `{ alreadyCompleted: true, reward: 0 }`

### –í–∞–ª–∏–¥–∞—Ü–∏—è

**–†–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–µ –∫–æ–¥—ã:**
- ‚ùå `INVALID_CODE` - –∫–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω
- ‚ùå `SELF_REFERRAL` - –ø–æ–ø—ã—Ç–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–≤–æ–π –∫–æ–¥

**–ö–≤–µ—Å—Ç—ã:**
- ‚ùå `QUEST_NOT_FOUND` - –∫–≤–µ—Å—Ç –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
- ‚ùå `MISSING_TG_ID` - –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç Telegram ID

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ç–µ—Å—Ç—ã
```bash
chmod +x api/test-autoprovision.sh
./api/test-autoprovision.sh
```

**–ß—Ç–æ —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç—Å—è:**
1. ‚úÖ Auto-provision –¥–≤—É—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
2. ‚úÖ –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–≥–æ –∫–æ–¥–∞
3. ‚úÖ –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–≥–æ –∫–æ–¥–∞
4. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è +100 PP
5. ‚úÖ –ó–∞–≥—Ä—É–∑–∫–∞ –∫–≤–µ—Å—Ç–æ–≤
6. ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–≤–µ—Å—Ç–∞
7. ‚úÖ –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –∫–≤–µ—Å—Ç–æ–≤
8. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –Ω–∞–≥—Ä–∞–¥
9. ‚úÖ –û—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –Ω–µ–≤–∞–ª–∏–¥–Ω–æ–≥–æ –∫–æ–¥–∞
10. ‚úÖ –û—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ self-referral
11. ‚úÖ –û—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –Ω–µ–≤–∞–ª–∏–¥–Ω–æ–≥–æ –∫–≤–µ—Å—Ç–∞

### –†—É—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

**–°—Ü–µ–Ω–∞—Ä–∏–π: –ø–æ–ª–Ω—ã–π flow**
```bash
# 1. –°–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è 1
curl "http://localhost:8787/api/ref/status?tgId=111111111"
# ‚Üí { referralCode: "REF111111ABC", balance: 1000 }

# 2. –°–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è 2
curl "http://localhost:8787/api/ref/status?tgId=222222222"

# 3. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å 2 –ø—Ä–∏–º–µ–Ω—è–µ—Ç –∫–æ–¥
curl -X POST http://localhost:8787/api/ref/apply \
  -H "Content-Type: application/json" \
  -d '{"tgId": "222222222", "code": "REF111111ABC"}'

# 4. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å 2 –≤—ã–ø–æ–ª–Ω—è–µ—Ç –∫–≤–µ—Å—Ç
curl -X POST http://localhost:8787/api/quests/complete \
  -H "Content-Type: application/json" \
  -d '{"tgId": "222222222", "key": "first_chat"}'

# 5. –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–∞–ª–∞–Ω—Å—ã
curl "http://localhost:8787/api/ref/status?tgId=111111111"
# ‚Üí { balance: 1100, refCount: 1, earned: 100 }

curl "http://localhost:8787/api/ref/status?tgId=222222222"  
# ‚Üí { balance: 1050 } (1000 + 50 –∑–∞ –∫–≤–µ—Å—Ç)
```

---

## üìÅ –§–∞–π–ª—ã

### –ò–∑–º–µ–Ω–µ–Ω—ã:
- `/api/index.js` - –¥–æ–±–∞–≤–ª–µ–Ω—ã endpoints –¥–ª—è auto-provision, —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤ –∏ –∫–≤–µ—Å—Ç–æ–≤

### –°–æ–∑–¥–∞–Ω—ã:
- `API-AUTO-PROVISION.md` - –ø–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏
- `api/test-autoprovision.sh` - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ç–µ—Å—Ç—ã
- `AUTOPROVISION-SUMMARY.md` - —ç—Ç–∞ —Å–≤–æ–¥–∫–∞

---

## üí° –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö

### User (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—ë—Ç—Å—è)
```javascript
{
  tgId: "123456789",
  referralCode: "REF456789XYZ",  // –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–æ–¥
  refCount: 0,                    // –ü—Ä–∏–≥–ª–∞—à–µ–Ω–æ –ª—é–¥–µ–π
  earned: 0,                      // –ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ PP
  balance: 1000,                  // –¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å
  completedQuests: [],            // ['first_chat', ...]
  referredBy: null,               // tgId –ø—Ä–∏–≥–ª–∞—Å–∏–≤—à–µ–≥–æ
  createdAt: 1234567890
}
```

### Quest (–±–∞–∑–æ–≤—ã–µ)
```javascript
{
  key: "first_chat",
  title: "–ü–µ—Ä–≤—ã–π –¥–∏–∞–ª–æ–≥",
  description: "–ù–∞—á–Ω–∏—Ç–µ —Ä–∞–∑–≥–æ–≤–æ—Ä —Å –ª—é–±—ã–º –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–º",
  reward: 50,
  icon: "üí¨"
}
```

---

## ‚úÖ Checklist

- [x] Auto-provision –ø–æ tgId
- [x] –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã—Ö –∫–æ–¥–æ–≤
- [x] GET /api/ref/status - —Å—Ç–∞—Ç—É—Å —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤
- [x] POST /api/ref/apply - –ø—Ä–∏–º–µ–Ω–∏—Ç—å –∫–æ–¥ (+100 PP)
- [x] GET /api/quests/status - —Å–ø–∏—Å–æ–∫ –∫–≤–µ—Å—Ç–æ–≤
- [x] POST /api/quests/complete - –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∫–≤–µ—Å—Ç
- [x] –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- [x] –í–∞–ª–∏–¥–∞—Ü–∏—è –∏ –∫–æ–¥—ã –æ—à–∏–±–æ–∫
- [x] curl –ø—Ä–∏–º–µ—Ä—ã
- [x] –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ç–µ—Å—Ç—ã
- [x] –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ì–û–¢–û–í–û

**–î–∞—Ç–∞:** 2025-10-13

