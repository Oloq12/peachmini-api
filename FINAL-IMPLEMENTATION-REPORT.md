# üéâ –§–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç - Auto-Provision API

## –î–∞—Ç–∞: 2025-10-13

---

## ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

### 1. **Auto-Provision System**
–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ Telegram ID –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—Ä–æ—Å–µ –∫ –ª—é–±–æ–º—É endpoint.

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:**
```javascript
{
  tgId: "123456789",
  referralCode: "REF456789XYZ",  // –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–æ–¥
  refCount: 0,                    // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–∏–≥–ª–∞—à—ë–Ω–Ω—ã—Ö
  earned: 0,                      // –ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ —Å —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤
  balance: 1000,                  // –°—Ç–∞—Ä—Ç–æ–≤—ã–π –±–∞–ª–∞–Ω—Å
  completedQuests: [],            // –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∫–≤–µ—Å—Ç—ã
  referredBy: null,               // –ö—Ç–æ –ø—Ä–∏–≥–ª–∞—Å–∏–ª
  createdAt: 1234567890
}
```

### 2. **Referral System**

#### GET `/api/ref/status?tgId=...`
- ‚úÖ Auto-provision –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—Ä–æ—Å–µ
- ‚úÖ –í–æ–∑–≤—Ä–∞—Ç —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–≥–æ –∫–æ–¥–∞, —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
- ‚úÖ –§–æ—Ä–º–∞—Ç –∫–æ–¥–∞: `REF{tgId-last6}{random3}`

#### POST `/api/ref/apply`
- ‚úÖ –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–≥–æ –∫–æ–¥–∞
- ‚úÖ –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ +100 PP –∞–≤—Ç–æ—Ä—É –∫–æ–¥–∞
- ‚úÖ –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å (–º–æ–∂–Ω–æ –ø—Ä–∏–º–µ–Ω–∏—Ç—å —Ç–æ–ª—å–∫–æ 1 —Ä–∞–∑)
- ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç self-referral
- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –∫–æ–¥–∞

### 3. **Quest System**

#### GET `/api/quests/status?tgId=...`
- ‚úÖ –°–ø–∏—Å–æ–∫ –∏–∑ 3 –±–∞–∑–æ–≤—ã—Ö –∫–≤–µ—Å—Ç–æ–≤
- ‚úÖ –°—Ç–∞—Ç—É—Å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ
- ‚úÖ –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (completed/total/earned)

#### POST `/api/quests/complete`
- ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–≤–µ—Å—Ç–∞ –ø–æ –∫–ª—é—á—É
- ‚úÖ –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ –Ω–∞–≥—Ä–∞–¥—ã
- ‚úÖ –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å (–Ω–∞–≥—Ä–∞–¥–∞ —Ç–æ–ª—å–∫–æ 1 —Ä–∞–∑)
- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –∫–≤–µ—Å—Ç–∞

### 4. **–ë–∞–∑–æ–≤—ã–µ –∫–≤–µ—Å—Ç—ã**
| Key | Title | Reward | Icon |
|-----|-------|--------|------|
| `first_chat` | –ü–µ—Ä–≤—ã–π –¥–∏–∞–ª–æ–≥ | 50 PP | üí¨ |
| `create_character` | –°–æ–∑–¥–∞—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ | 100 PP | ‚ú® |
| `invite_friend` | –ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –¥—Ä—É–≥–∞ | 150 PP | üë• |

---

## üì° API Endpoints Summary

| Method | Endpoint | –û–ø–∏—Å–∞–Ω–∏–µ |
|--------|----------|----------|
| GET | `/api/ref/status?tgId=...` | –°—Ç–∞—Ç—É—Å —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤ (auto-provision) |
| POST | `/api/ref/apply` | –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –∫–æ–¥ (+100 PP) |
| GET | `/api/quests/status?tgId=...` | –°–ø–∏—Å–æ–∫ –∫–≤–µ—Å—Ç–æ–≤ (auto-provision) |
| POST | `/api/quests/complete` | –í—ã–ø–æ–ª–Ω–∏—Ç—å –∫–≤–µ—Å—Ç (–Ω–∞—á–∏—Å–ª–∏—Ç—å –Ω–∞–≥—Ä–∞–¥—É) |

---

## üîê –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

### –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å

**–†–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–µ –∫–æ–¥—ã:**
```javascript
// –ü–µ—Ä–≤–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ
{ credited: true, amount: 100 }

// –ü–æ–≤—Ç–æ—Ä–Ω–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ
{ credited: false, alreadyApplied: true, message: "..." }
```

**–ö–≤–µ—Å—Ç—ã:**
```javascript
// –ü–µ—Ä–≤–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
{ done: true, reward: 50, newBalance: 1050 }

// –ü–æ–≤—Ç–æ—Ä–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
{ done: true, alreadyCompleted: true, reward: 0 }
```

### –í–∞–ª–∏–¥–∞—Ü–∏—è

**–ö–æ–¥—ã –æ—à–∏–±–æ–∫:**
- `MISSING_TG_ID` - –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç Telegram ID
- `MISSING_FIELDS` - –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è
- `INVALID_CODE` - —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –∫–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω
- `SELF_REFERRAL` - –ø–æ–ø—ã—Ç–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–≤–æ–π –∫–æ–¥
- `QUEST_NOT_FOUND` - –∫–≤–µ—Å—Ç –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç

**–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–æ–≤:**
```json
// –£—Å–ø–µ—Ö
{ "ok": true, "data": {...} }

// –û—à–∏–±–∫–∞
{ "ok": false, "error": "message", "code": "ERROR_CODE" }
```

---

## üìã –§–∞–π–ª—ã

### –ò–∑–º–µ–Ω—ë–Ω–Ω—ã–µ:
```
api/index.js                    +549 -41 lines
```

### –°–æ–∑–¥–∞–Ω–Ω—ã–µ:
```
API-AUTO-PROVISION.md           –ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
AUTOPROVISION-SUMMARY.md        –ö—Ä–∞—Ç–∫–∞—è —Å–≤–æ–¥–∫–∞
CURL-EXAMPLES.md                curl –ø—Ä–∏–º–µ—Ä—ã
api/test-autoprovision.sh       –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ç–µ—Å—Ç—ã
FINAL-IMPLEMENTATION-REPORT.md  –≠—Ç–æ—Ç –æ—Ç—á—ë—Ç
```

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ç–µ—Å—Ç—ã
```bash
chmod +x api/test-autoprovision.sh
./api/test-autoprovision.sh
```

**–ü–æ–∫—Ä—ã—Ç–∏–µ —Ç–µ—Å—Ç–∞–º–∏:**
- [x] Auto-provision –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- [x] –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã—Ö –∫–æ–¥–æ–≤
- [x] –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–≥–æ –∫–æ–¥–∞
- [x] –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤
- [x] –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ +100 PP
- [x] –ó–∞–≥—Ä—É–∑–∫–∞ –∫–≤–µ—Å—Ç–æ–≤
- [x] –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–≤–µ—Å—Ç–æ–≤
- [x] –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –∫–≤–µ—Å—Ç–æ–≤
- [x] –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ –Ω–∞–≥—Ä–∞–¥
- [x] –í–∞–ª–∏–¥–∞—Ü–∏—è –æ—à–∏–±–æ–∫
- [x] Self-referral –∑–∞—â–∏—Ç–∞
- [x] –ù–µ–≤–∞–ª–∏–¥–Ω—ã–µ –∫–≤–µ—Å—Ç—ã

### –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

**–ü–æ–ª–Ω—ã–π flow:**
```bash
# 1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å 1 —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç—Å—è
curl "$API_URL/ref/status?tgId=111111111"
# ‚Üí { referralCode: "REF111111ABC", balance: 1000 }

# 2. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å 2 –ø—Ä–∏–º–µ–Ω—è–µ—Ç –∫–æ–¥
curl -X POST "$API_URL/ref/apply" \
  -H "Content-Type: application/json" \
  -d '{"tgId": "222222222", "code": "REF111111ABC"}'
# ‚Üí –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å 1: +100 PP

# 3. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å 2 –≤—ã–ø–æ–ª–Ω—è–µ—Ç –∫–≤–µ—Å—Ç—ã
curl -X POST "$API_URL/quests/complete" \
  -H "Content-Type: application/json" \
  -d '{"tgId": "222222222", "key": "first_chat"}'
# ‚Üí +50 PP

curl -X POST "$API_URL/quests/complete" \
  -H "Content-Type: application/json" \
  -d '{"tgId": "222222222", "key": "create_character"}'
# ‚Üí +100 PP

# 4. –ò—Ç–æ–≥–æ–≤—ã–µ –±–∞–ª–∞–Ω—Å—ã:
# User 1: 1100 PP (1000 + 100 —Ä–µ—Ñ–µ—Ä–∞–ª)
# User 2: 1150 PP (1000 + 50 + 100 –∫–≤–µ—Å—Ç—ã)
```

---

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

### –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–¥–µ
```
api/index.js: 590 –∏–∑–º–µ–Ω–µ–Ω–∏–π (+549, -41)
- –î–æ–±–∞–≤–ª–µ–Ω–æ: 23 –Ω–æ–≤—ã–µ —Å—Ç—Ä–æ–∫–∏ mock data
- –î–æ–±–∞–≤–ª–µ–Ω–æ: 26 —Å—Ç—Ä–æ–∫ helper functions
- –î–æ–±–∞–≤–ª–µ–Ω–æ: 235 —Å—Ç—Ä–æ–∫ endpoints (4 –Ω–æ–≤—ã—Ö)
```

### –ù–æ–≤—ã–µ endpoints
- 4 endpoint'–∞
- 8 —Ç–∏–ø–æ–≤ –æ—à–∏–±–æ–∫
- 2 —Å–∏—Å—Ç–µ–º—ã (referral + quests)
- 100% –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å

### –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- 5 –Ω–æ–≤—ã—Ö markdown —Ñ–∞–π–ª–æ–≤
- 1 —Ç–µ—Å—Ç–æ–≤—ã–π bash —Å–∫—Ä–∏–ø—Ç
- ~1500 —Å—Ç—Ä–æ–∫ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
- 50+ curl –ø—Ä–∏–º–µ—Ä–æ–≤

---

## üöÄ Deployment

### –õ–æ–∫–∞–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫
```bash
cd api
npm install
node index.js
# –∏–ª–∏
vercel dev
```

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
```bash
export API_URL="http://localhost:8787/api"
./api/test-autoprovision.sh
```

### Production deploy
```bash
cd api
vercel --prod
```

---

## ‚úÖ Checklist

### API
- [x] Auto-provision –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- [x] –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∫–æ–¥–æ–≤
- [x] GET /api/ref/status
- [x] POST /api/ref/apply
- [x] GET /api/quests/status
- [x] POST /api/quests/complete
- [x] –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- [x] –í–∞–ª–∏–¥–∞—Ü–∏—è –∏ error handling
- [x] –°—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–æ–≤

### –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- [x] –ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è (API-AUTO-PROVISION.md)
- [x] –ö—Ä–∞—Ç–∫–∞—è —Å–≤–æ–¥–∫–∞ (AUTOPROVISION-SUMMARY.md)
- [x] curl –ø—Ä–∏–º–µ—Ä—ã (CURL-EXAMPLES.md)
- [x] –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ç–µ—Å—Ç—ã (test-autoprovision.sh)
- [x] –§–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç—á—ë—Ç (—ç—Ç–æ—Ç —Ñ–∞–π–ª)

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- [x] 12 –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ç–µ—Å—Ç–æ–≤
- [x] –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏
- [x] –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
- [x] –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–π
- [x] Edge cases –ø–æ–∫—Ä—ã—Ç—ã

---

## üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç

‚úÖ **–ü–æ–ª–Ω–æ—Å—Ç—å—é —Ä–∞–±–æ—á–∞—è —Å–∏—Å—Ç–µ–º–∞ auto-provision —Å:**
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º —Å–æ–∑–¥–∞–Ω–∏–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π –ø—Ä–æ–≥—Ä–∞–º–º–æ–π (+100 PP –∑–∞ —Ä–µ—Ñ–µ—Ä–∞–ª–∞)
- –°–∏—Å—Ç–µ–º–æ–π –∫–≤–µ—Å—Ç–æ–≤ (3 –∫–≤–µ—Å—Ç–∞, –¥–æ 300 PP –Ω–∞–≥—Ä–∞–¥)
- –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å—é –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- –ü–æ–ª–Ω–æ–π –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π –∏ error handling
- –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–µ–π –∏ —Ç–µ—Å—Ç–∞–º–∏

**–ì–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –≤ production!** üöÄ

---

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ó–ê–í–ï–†–®–ï–ù–û
**–î–∞—Ç–∞:** 2025-10-13

