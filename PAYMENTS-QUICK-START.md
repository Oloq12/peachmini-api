# âš¡ Quick Start - Real Telegram Stars Payments

## Ğ§Ñ‚Ğ¾ ÑĞ´ĞµĞ»Ğ°Ğ½Ğ¾ âœ…

### 1. **API Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½**
- âœ… Ğ—Ğ°Ğ¼ĞµĞ½Ñ‘Ğ½ STUB Ğ½Ğ° Ñ€ĞµĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ `createInvoiceLink()`
- âœ… Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½ webhook `/api/payments/webhook`
- âœ… ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° `pre_checkout_query` Ğ¸ `successful_payment`
- âœ… ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¾Ğµ Ğ½Ğ°Ñ‡Ğ¸ÑĞ»ĞµĞ½Ğ¸Ğµ `users.balance`

### 2. **Bot Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½**
- âœ… ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ° `/store` - Ğ¼Ğ°Ğ³Ğ°Ğ·Ğ¸Ğ½ ĞºÑ€Ğ¸ÑÑ‚Ğ°Ğ»Ğ»Ğ¾Ğ²
- âœ… ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸Ğº `pre_checkout_query`
- âœ… ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸Ğº `successful_payment`
- âœ… Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾ÑĞ»Ğµ Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ñ‹

---

## ğŸš€ Ğ‘Ñ‹ÑÑ‚Ñ€Ñ‹Ğ¹ ÑÑ‚Ğ°Ñ€Ñ‚

### Ğ¨Ğ°Ğ³ 1: Enable Payments Ğ² @BotFather

```
ĞÑ‚ĞºÑ€Ñ‹Ñ‚ÑŒ: https://t.me/BotFather

ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹:
/setinvoice
â†’ Ğ’Ñ‹Ğ±Ñ€Ğ°Ñ‚ÑŒ Ğ²Ğ°ÑˆĞµĞ³Ğ¾ Ğ±Ğ¾Ñ‚Ğ°
â†’ Stars â­

ĞÑ‚Ğ²ĞµÑ‚:
âœ… Success! Your bot can now accept payments in Stars.
```

### Ğ¨Ğ°Ğ³ 2: Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ BOT_TOKEN Ğ² Vercel

```bash
# Ğ’ Vercel Dashboard
Settings â†’ Environment Variables â†’ Add

Name: BOT_TOKEN
Value: 1234567890:ABCdefGHIjklMNOpqrsTUVwxyz
Scope: Production
```

### Ğ¨Ğ°Ğ³ 3: Redeploy

```bash
cd /Users/egor/Desktop/peach-mini
npx vercel --prod --yes
```

### Ğ¨Ğ°Ğ³ 4: Restart Bot

```bash
cd /Users/egor/Desktop/peach-mini/bot
npm start
```

### Ğ¨Ğ°Ğ³ 5: Test

```
Ğ’ Ğ±Ğ¾Ñ‚Ğµ:
/store

Ğ’Ñ‹Ğ±Ñ€Ğ°Ñ‚ÑŒ Ğ¿Ğ°ĞºĞµÑ‚ â†’ ĞĞ¿Ğ»Ğ°Ñ‚Ğ¸Ñ‚ÑŒ â†’ Ğ“Ğ¾Ñ‚Ğ¾Ğ²Ğ¾!
```

---

## ğŸ§ª ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹

### Test ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹ /store

```
User: /store

Bot Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚:
ğŸ’ ĞœĞĞ“ĞĞ—Ğ˜Ğ ĞšĞ Ğ˜Ğ¡Ğ¢ĞĞ›Ğ›ĞĞ’

[ğŸ’ ĞœĞ°Ğ»Ñ‹Ğ¹ (300â­ â†’ 300ğŸ’)]
[ğŸ’ Ğ¡Ñ€ĞµĞ´Ğ½Ğ¸Ğ¹ (600â­ â†’ 549ğŸ’) +10%]
[ğŸ’ Ğ‘Ğ¾Ğ»ÑŒÑˆĞ¾Ğ¹ (850â­ â†’ 799ğŸ’) +20%]
```

### Test Ğ¿Ğ¾ĞºÑƒĞ¿ĞºĞ¸

```
1. ĞĞ°Ğ¶Ğ°Ñ‚ÑŒ Ğ½Ğ° Ğ¿Ğ°ĞºĞµÑ‚
2. Bot Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ÑĞµÑ‚ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ñ ĞºĞ½Ğ¾Ğ¿ĞºĞ¾Ğ¹ [ğŸ’³ ĞĞ¿Ğ»Ğ°Ñ‚Ğ¸Ñ‚ÑŒ]
3. ĞšĞ»Ğ¸Ğº â†’ Telegram Stars payment screen
4. ĞŸĞ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ´Ğ¸Ñ‚ÑŒ Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ñƒ
5. Bot Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑ‚: "âœ… +300ğŸ’"
```

### ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ»Ğ¾Ğ³Ğ¾Ğ²

**API logs (Vercel):**
```
âœ… Telegram Bot API initialized
âœ… /payments/createInvoice: REAL invoice created pay_123
ğŸ” Pre-checkout query: pay_123
âœ… Pre-checkout: OK for pay_123
ğŸ’° Successful payment: pay_123
âœ… Payment processed: pay_123 +300ğŸ’ â†’ balance=1300
```

**Bot logs:**
```
ğŸ’ Crystal purchase attempt: 123456789 â†’ small
âœ… Invoice sent to 123456789: https://t.me/invoice/...
ğŸ” Pre-checkout query: pay_123
âœ… Pre-checkout: OK for pay_123
ğŸ’° Successful payment: pay_123
âœ… Crystals credited: 123456789 +300ğŸ’
```

---

## ğŸ“‹ Packages

| Package | Stars | Crystals | Bonus |
|---------|-------|----------|-------|
| Small | 300â­ | 300ğŸ’ | - |
| Medium | 600â­ | 549ğŸ’ | +10% |
| Large | 850â­ | 799ğŸ’ | +20% |

---

## ğŸ”„ Flow Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ User: /storeâ”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Bot: show packages  â”‚
â”‚ [Small] [Med] [Lrg] â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ Click
       v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Bot â†’ API createInvoice    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ API â†’ Telegram Bot API     â”‚
â”‚ createInvoiceLink()        â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Bot: [ğŸ’³ ĞĞ¿Ğ»Ğ°Ñ‚Ğ¸Ñ‚ÑŒ] URL btn â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ Click
       v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Telegram Stars payment UI  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ Confirm
       v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ pre_checkout_query         â”‚
â”‚ â†’ Bot â†’ API webhook        â”‚
â”‚ â†’ API validates            â”‚
â”‚ â†’ answerPreCheckoutQuery   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ successful_payment         â”‚
â”‚ â†’ Bot â†’ API webhook        â”‚
â”‚ â†’ API: balance += amount   â”‚
â”‚ â†’ Bot: notify user         â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âœ… +300ğŸ’                  â”‚
â”‚ Balance: 1300 PP           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## âš ï¸ Troubleshooting

### Invoice Ğ½Ğµ ÑĞ¾Ğ·Ğ´Ğ°ĞµÑ‚ÑÑ

**ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ°:** Dev mode stub Ğ²Ğ¼ĞµÑÑ‚Ğ¾ Ñ€ĞµĞ°Ğ»ÑŒĞ½Ğ¾Ğ³Ğ¾ invoice

**Ğ ĞµÑˆĞµĞ½Ğ¸Ğµ:**
```bash
# ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ BOT_TOKEN Ğ² Vercel
vercel env ls

# Ğ•ÑĞ»Ğ¸ Ğ½ĞµÑ‚ - Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ:
vercel env add BOT_TOKEN production
vercel --prod --yes
```

**Ğ›Ğ¾Ğ³ Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ Ğ¿Ğ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ:**
```
âœ… Telegram Bot API initialized
âœ… /payments/createInvoice: REAL invoice created
```

### pre_checkout_query Ğ½Ğµ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚

**ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ°:** answerPreCheckoutQuery timeout

**Ğ ĞµÑˆĞµĞ½Ğ¸Ğµ:**
- ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ Ñ‡Ñ‚Ğ¾ API_URL Ğ² bot/.env ÑƒĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ Ğ½Ğ° production
- ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ Ñ‡Ñ‚Ğ¾ /api/payments/webhook Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ĞµĞ½
- ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ Ğ»Ğ¾Ğ³Ğ¸ Vercel

### Ğ‘Ğ°Ğ»Ğ°Ğ½Ñ Ğ½Ğµ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ÑĞµÑ‚ÑÑ

**ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ°:** successful_payment Ğ½Ğµ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ğ½

**Ğ ĞµÑˆĞµĞ½Ğ¸Ğµ:**
```bash
# ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ Ğ»Ğ¾Ğ³Ğ¸ Ğ±Ğ¾Ñ‚Ğ°
# Ğ”Ğ¾Ğ»Ğ¶Ğ½Ğ¾ Ğ±Ñ‹Ñ‚ÑŒ:
ğŸ’° Successful payment: pay_123
âœ… Crystals credited: 123456789 +300ğŸ’

# ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ API logs
âœ… Payment processed: pay_123 +300ğŸ’ â†’ balance=1300
```

---

## âœ… Checklist

ĞŸĞ¾ÑĞ»Ğµ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑŒÑ‚Ğµ:

- [ ] @BotFather: Payments enabled (/setinvoice â†’ Stars)
- [ ] Vercel: BOT_TOKEN Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½
- [ ] API: redeploy Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½
- [ ] Bot: Ğ¿ĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑ‰ĞµĞ½ Ñ BOT_TOKEN
- [ ] Test: /store Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ Ğ¿Ğ°ĞºĞµÑ‚Ñ‹
- [ ] Test: ĞºĞ»Ğ¸Ğº Ğ½Ğ° Ğ¿Ğ°ĞºĞµÑ‚ â†’ ĞºĞ½Ğ¾Ğ¿ĞºĞ° "ĞĞ¿Ğ»Ğ°Ñ‚Ğ¸Ñ‚ÑŒ"
- [ ] Test: Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ğ° â†’ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ "âœ… +300ğŸ’"
- [ ] Test: Ğ±Ğ°Ğ»Ğ°Ğ½Ñ ÑƒĞ²ĞµĞ»Ğ¸Ñ‡ĞµĞ½ Ñ‡ĞµÑ€ĞµĞ· API

---

## ğŸ”— Endpoints

**API:**
- POST `/api/payments/createInvoice` - ÑĞ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ invoice
- POST `/api/payments/webhook` - Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ñ‚ÑŒ Ğ¿Ğ»Ğ°Ñ‚ĞµĞ¶
- POST `/api/payments/check` - Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ ÑÑ‚Ğ°Ñ‚ÑƒÑ (Ğ¾Ğ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾)

**Bot:**
- `/store` - Ğ¼Ğ°Ğ³Ğ°Ğ·Ğ¸Ğ½
- `crystals_small|medium|large` - Ğ²Ñ‹Ğ±Ğ¾Ñ€ Ğ¿Ğ°ĞºĞµÑ‚Ğ°

---

**Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ:** âœ… Ğ“Ğ¾Ñ‚Ğ¾Ğ²Ğ¾! ĞÑÑ‚Ğ°Ğ»Ğ¾ÑÑŒ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ BOT_TOKEN Ğ¸ Ğ¿Ñ€Ğ¾Ñ‚ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ!

**Ğ”Ğ°Ñ‚Ğ°:** 2025-10-13

